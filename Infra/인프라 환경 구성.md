## 인프라 환경 구성

![Untitled-2021-10-26-1601](https://user-images.githubusercontent.com/79683414/139526200-35e35b9e-7ccb-43ae-9054-087fa723c128.png)

<br>

## 과제 및 Q&A 목록

- ESXI를 이용한 기본적 인프라 구축 완료(WAN, LAN, 내부 네트워크)

- VyOS 가상 라우터 설치

- PfSense 방화벽 설치

- Port Forwarding 및 내부 네트워크 Default 룰 설정

  네트워크 장비에 연결만 되있다면 다른 네트워크 대역이라도 핑이 보내짐. 다른 네트워크 대역은 통신이 불가능 하다고 알고 있었음.

  왜? > 라우터에 연결되어 있고 address table을 참고하기 때문. 네트워크 간 통신을 제어하기 위해 PfSense의 룰을 설정해 주어야 함.

- dev-net 인터넷 연결되도록 설정 해보기

  단순히 HTTP(80), HTTPS(443) 포트로 TCP만 열어주면 인터넷에 접속 가능할 것이라 생각했지만 TCP/UDP 로 해야했다. 연속성이 필요한 웹 요소들로 인해 UDP가 사용된다는 점을 배웠다.

- Squid Proxy 및 Proxy Guard 설치

- dev-net Proxy/DNS 룰 허용

  사설망 연결 시 인터넷 접속 안됨 > 사설망들은 PfSense 를 경유하기 때문에,

  각각 패킷을 통과시키도록 룰을 설정해야함. 위에서 연결한 룰 세팅은 Proxy 를 경유하지 않는다.

- DEVNET - allow dns 룰을 WAN 카테고리에 옮겨도 상관 없을 것 같다

  테스트 결과 > 

- PROXY - Transparent 모드 미사용 시 연결된 호스트들 마다 PROXY 를 각각 설정해 주어야 한다

  TP 모드로 바꾸고 호스트의 PROXY 를 '시스템 프록시'로 세팅 > PROXY 연결 성공, TCP_MISS 로그 확인 및 인터넷 연결 안됨 > 

- Snort 설치

  Legacy : 패킷을 복사해서 트래픽을 먼저 보낸 후 복사한 데이터 검사(성능 항상, 보안 하락)

  Inline : 검사를 한 후 통과시키는 모드

- Security Onion 16.04 설치

- Security Onion <-> soc-net(보안 관리) ssh 연결 설정. soc 에서 sguil 창을 원격으로 띄움

  ssh -X 옵션을 처음 접했는데(X11 forwarding) 서버에서 실행중인 Graphical application 을 접근 할 수 있도록 포워딩하는 기능이다. ssh 로 그래픽적인 동작이 가능했다니...

- Security Onion 정상 동작 확인, so-test > 실패 > so-rule-update + 네트워크 설정 후 재부팅 해주니 성공...

- 기본 설정된 Path Traversal 룰 테스트 성공, "/../../../../ ... /etc/passwd" 사용함.

  커스텀 룰(/etc/nsm/rules/local.rules) 설정 후 테스트 > sguil에서 패킷 감지 성공 확인

  커스텀 룰은 sid 를 3000001 부터 부여해야 함. 룰 생성 날짜를 이용하기도 함. 

- 연습 문제

  1) 웹 서버에서 외부로 가는 패킷, 메시지 : "Directory Browsing Vuln",

     탐지 문자열 : index of /, 대소문자 무시, 클래스 타입 : web-application-attack

  2)  외부에서 웹 서버로 가는 패킷, 메세지 : "Persistent XSS in POST",

     탐지 문자열 : "script%3e", 대소문자 무시, 클라이언트 바디에서 탐지,

     클래스 타입: web-application-attack

  1> alert tcp $HTTP_SERVERS any -> $EXTERNAL_NET any (msg:"Directory Browsing Vuln"; content:"index of /"; nocase; classtype:web-application-attack; sid:3000002; rev:1;)

  2> alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS any (msg:"Persistent XSS in POST"; content:"script%3e"; nocase; http_client_body; classtype:web-application-attack; sid:3000003; rev:1;)

- 룰 작성 요령 - 어느 시점에, 어디로 가는 패킷인지 잘 파악해야 한다

- IDS - Alert 용도로 사용, Alert 중 차단이 필요한 룰을 IPS(PfSense-snort-custom.rules) 에 작성. IDS 가 비교적 하드웨어 자원이 많이 필요한 듯 하다.

- TLS 통신 ? SSL? HTTP/HTTPS 차이점?

- WAF(ModSecurity) 설치 - ubuntu-20.04, nginx

  /etc/nginx/modsec/main.conf 에 테스트 룰 설정 후 테스트 성공
