## 인프라 구성

- "인프라 보안" - 강병탁님

- "Esxi 가상 인프라 구축과 보안 솔루션을 활용한 이상 징후 탐지 모니터링 " - 보안프로젝트(인프런)

위 두 가지를 학습한 후 더 깊은 이해와 복습을 위해 직접 구성하였다. 실습 환경이 최근의 버전과 맞지 않은 경우도 있었고 두 가지 환경을 응용해서 구성해보고 싶었다.

~~실습한 인프라와 큰 차이는 없다.~~

## Esxi 구성

Esxi vSphere hypervisor 6.7

Processors : 8

RAM : 24 GB

SSD : 450GB

<br>

Virtual Switchs

- vSwitch0 : Esxi 관리용 인터페이스
- vSwitch_WAN : 인프라용 WAN
- vSwitch_DMZ : DMZ 구역 전용
- vSwitch_LAN : 내부 네트워크, VLANs 를 통한 망분리

## 리눅스 초기 설정

- DHCP/STATIC 에 따라 /etc/netplan/interface~~~ 파일을 설정.
- ifconfig 가능하도록 `apt install net-tools`
- DNS연결 실패하는 경우가 생겨서 `apt install resolvconf` 로 영구적인 DNS 설정. 

## Images

- 라우터 : vyos-1.1.8

- DB서버 : ubuntu-server-20.04
- 리눅스 데스크탑 : xubuntu-20.04, linuxmint-20.1
- IPS : pfSense-2.5.2
- IDS : SecurityOnion-16.04
- WAF : modsecurity
- 윈도우 : win10
- 취약한 웹 : bee-box-1.6
- 공격자 : Kali-21.2
- 추가 패키지 : Squid Proxy/Guard, snort, splunkforwarder



## 네트워크 구성

__Esxi 내부 관점__ 의 구성이다. LAB 환경이므로  DEV는 DHCP이고 나머지는 Static으로 할당해주었다. DEV과 같이 네트워크 변동 사항이 빈번한 대역은 DHCP, 반대로 보안/네트워크 장비는 Static이 용이하다고 판단했다.

 ~~DHCP 로 했다가 네트워크가 꼬여 Security Onion 재설치한 경험이 있다 ...~~

~~참고로, 원인은 'pfSense가 구동 되기 전에 다른 장비를 먼저 ON 해서'였다.~~

<br>

![image](https://user-images.githubusercontent.com/79683414/142722678-5360ac4d-a5aa-4af0-b08c-cbe821576278.png)

<br>

__라우터(WAN)__

- pfSense(IPS) : 방화벽
- DMZ : 웹 서버가 존재하는 망

__내부망(VLANs)__

- 10_SOC : 'Security Operation Center' 보안/네트워크 엔지니어들이 사용

- 20_INTRA : 내부망으로 인가된 직원만 접근 가능. IDS, Splunk로 구성되어있음.
- 30_DEV : 개발 본부. Window 환경 구성을 테스트하기 위해 추가하였다.
- 40_PUBLIC : 인터넷 연결을 위한 망. 프록시를 사용한다.

<br><br>

아직 회사 경험이 없어 지금까지 배운 지식을 토대로 네트워크를 구축했다.

비즈니스 모델, 방화벽, 네트워크 장비 등에 따라 구성을 다르기 때문에 내가 하고 싶은 대로 구성하였다. ~~이것이 LAB의 장점!~~

## 네트워크 요구 사항

__DMZ__

- 외부망(WAN)의 웹 접근만(HTTP/HTTPS) 허용된다. (apt update 불가능)
- 내부에서는 개발팀만 접근 가능하다. (즉, 개발팀과 서비스 고객들만 접근 가능하다.)
- DMZ 에서 나가는 패킷은 차단한다.

__10_SOC__

- 보안 담당자는 Intranet, pfSense 에 HTTP 접근이 가능해야 한다. 다른 모든 outbound는 차단.
- 보안 담당자의 IP를 룰에 명시하자. 방화벽에 접근하는 것은 NET 망으로 설정하는 것 보안 담당자의 IP 를 따로 선언하는  것이 적절하다고 판단. 담당자가 늘어나면 Alias 로 관리.
- 인터넷 연결을 위한 VLAN 할당.
- 20_INTRA 에 SSH - X11 접속 허용. SOC 에서 Security Onion 의 Sguil 을 GUI로 실행시키기 위함.

__20_INTRA__

- 내부 DB, Security Onion(IDS), Splunk(로그관리) 등이 위치함.

- 인가된 사용자만 접근 가능.

- 10_SOC에 SSH -  X11접속 허용

  

__30_DEV(DHCP)__

- DMZ를 제외한 다른 내부 네트워크(RFC1918)에 접근 할 수 없다.
- DMZ 에 HTTP(S)/SSH 접근이 가능하다.

__40_PUBLIC(DHCP)__

- 외부 네트워크와 프록시를 통해 연결된다.
- 내부 네트워크에 접근 할 수 없다.

<br>

___인터넷이 가능한 망은 Squid Proxy/Guard를 사용한다___

__Proxy 사용 주의!! SOC에서 DMZ로 접속이 가능한 이슈 발생, SOC에서 DMZ로 가는 연결이 방화벽을 거치지 않고 프록시로 우회해버림. 내부 네트워크의 트래픽을 방화벽으로 forwarding 해주는 옵션(proxy>general 에 있다)을 사용하자. __

__Proxy를 사용한다고 해서 방화벽으로 막아버리면 통신 불가능. DNS query 는 프록시에 안잡히는 것 같음...._

<br><br>

DB 서버는 DMZ영역, VLAN 영역에 위치할 것으로 구상했지만 사양이 부족해서 따로 구현하지는 않았다. 기초 웹 해킹을 주로 테스트 할 예정으로 크게 문제는 없을 것이라 판단했다.



## To Do List



어니언 룰 테스트 중 오류 발생 - curl securityonion.com 시 302 found > 해결하고 룰 테스트, http > https 로 redirect 하는 과정 중에 오류가 발생하는 듯함.

웹 방화벽 설치/ 테스트

스플렁크 설치/ 테스트.

공격 및 시큐리티 어니언 룰 설정 실습



 ex) 오탐 대처(스레시 홀드 이용), 새로운 룰 추가, 튜닝 하는법 등

